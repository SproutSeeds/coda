# Implementation Plan: Coda MVP

**Branch**: `001-build-a-lightweight` | **Date**: 2025-10-05 | **Spec**: `specs/001-build-a-lightweight/spec.md`
**Input**: Feature specification from `specs/001-build-a-lightweight/spec.md`

## Execution Flow (/plan command scope)
```
1. Verify scaffold gate (G0). If `.specify/memory/scaffold.ok` is absent, queue T000 (Next.js scaffold) before feature work.
2. Read feature specification + clarifications and extract functional scope.
3. Load constitution (`.specify/memory/constitution.md`) and ensure stack alignment.
4. Populate Technical Context and Constitution Check with concrete decisions from research.
5. Execute Phase 0 updates → refresh `research.md` with finalized decisions (complete).
6. Execute Phase 1 design → update `data-model.md`, `contracts/`, `quickstart.md`, and rerun `update-agent-context.sh codex`.
7. Re-run constitution sanity check; capture any deviations in Complexity Tracking.
8. Define Phase 2 task planning approach (stop before generating `tasks.md`).
9. Report readiness for `/tasks`.
```

## Summary
Coda MVP delivers a single-user workspace for capturing, searching, and pruning project ideas. The plan enforces the constitution’s Next.js App Router stack, ensures performant search via Postgres trigram indexes, codifies undo flows backed by soft deletes, and prepares CI/CD plus observability hooks so `/tasks` can generate an execution-ready backlog. Upcoming auth work adds passwordless email magic-link sign-in (Auth.js Email provider + Drizzle adapter) plus optional password credentials without regressing rate limiting or analytics.

## Technical Context
**Language/Version**: TypeScript 5.x targeting Next.js 14 App Router  
**Primary Dependencies**: Next.js (App Router RSC + Server Actions), Tailwind CSS + shadcn/ui, Framer Motion, Auth.js (email magic links + password credentials + dev Credentials), Drizzle ORM + drizzle-zod, Upstash Redis rate limiter, Vercel Analytics  
**Storage**: PostgreSQL (Vercel Postgres in prod, Neon for local dev) with Drizzle migrations  
**Testing**: Vitest (unit), Playwright (e2e smoke + undo), Lighthouse CI budget checks  
**Target Platform**: Vercel-hosted web application with preview + production environments  
**Project Type**: Single-tenant Next.js App Router web app  
**Performance Goals**: LCP < 2.5 s, CLS ~0, TTI ≤ 2 s on mid-tier 4G; server responses <300 ms create, <400 ms search  
**Constraints**: Authenticated access only; motion capped at 200 ms with prefers-reduced-motion fallbacks; undo window 10 s; Lighthouse ≥90 across categories; bcrypt cost ≥12; rate limiting per user/session (including email link requests)  
**Scale/Scope**: Single user per deployment, ≤1,000 active ideas, soft-deleted rows purged after 30 days

## Constitution Check
*Status: ✅ Scaffold ready*

- **Stack Alignment**: Planned implementation matches mandated stack (Next.js App Router + Tailwind + shadcn + Drizzle + Auth.js + Upstash). ✅
- **Scaffold Gate (G0)**: `.specify/memory/scaffold.ok` present after T000 scaffold run. ✅
- **Data & Validation**: Drizzle schema + drizzle-zod validators defined; soft-delete + undo fields recorded. ✅
- **Deployment & CI**: Plan enforces pnpm `lint`, `typecheck`, `build`, Drizzle migrations, GitHub Actions + Vercel previews. ✅
- **Security & Rate Limiting**: Auth.js session gating, Upstash rate limiter, bcrypt ≥12 noted. ✅
- **Performance & A11y**: Motion tokens, WCAG AA, Lighthouse budgets documented. ✅
- **Exceptions**: None requested; continue monitoring for deviations. ✅

## Project Structure

### Documentation (this feature)
```
specs/001-build-a-lightweight/
├── plan.md          # Implementation plan (this file)
├── research.md      # Finalized decisions (Phase 0)
├── data-model.md    # Schema + state transitions (Phase 1)
├── quickstart.md    # Developer runbook (Phase 1)
├── contracts/       # API & Server Action contracts (Phase 1)
└── tasks.md         # Generated by /tasks (not in scope yet)
```

### Source Code (repository root)
```
app/
  (routes: login, dashboard/ideas, API handlers via Server Actions)
components/
  (shadcn/ui primitives + feature components)
lib/
  auth/
  db/
  validations/
  utils/
scripts/
tests/
  unit/
  e2e/
```

**Structure Decision**: Maintain constitution-aligned monorepo structure with feature-centric components in `app/dashboard/ideas`; shared utilities live in `lib/`, and motion tokens centralized in `lib/utils/motion.ts`.

## Phase 0: Outline & Research (Complete)
- All unknowns resolved in `research.md` (Markdown sanitization, undo retention, trigram search, motion tokens, analytics scope, Upstash rate limiting).
- No additional research tasks required before `/tasks`.
- Keep `research.md` authoritative; revisit only if new dependencies introduced during implementation.

## Phase 1: Design & Contracts (Complete)
- `data-model.md` documents Idea entity (soft delete + undo fields) and optional `idea_search_audit` table.
- `contracts/` directory defines Server Actions / API contracts for create, edit, list, search, delete, undo with auth, validation, and rate limiting notes.
- `quickstart.md` provides environment setup, migrations, rate limiter config, CI gates, and observability guidance.
- Next action before implementation is to rerun agent context sync when plan changes:
  ```bash
  SPECIFY_FEATURE=001-build-a-lightweight \
  .specify/scripts/bash/update-agent-context.sh codex
  ```
  (Run once more after scaffold exists to ensure instructions stay current.)

## Phase 2: Task Planning Approach (Ready for /tasks)
- `/tasks` will load `.specify/templates/tasks-template.md` and generate ~25–30 tasks covering:
  - T000 scaffold (until `.specify/memory/scaffold.ok` present)
  - Database migrations + Drizzle schema for Idea + soft delete fields
  - Server Actions/tests for create, edit, list, search, delete, undo
  - UI components (composer, list, search, empty/error states) with motion tokens
  - Auth gates and rate limiting middleware
  - NEW: Auth.js email provider tables/migrations, magic-link send/verify Server Actions, and associated UI flows/tests
  - Vitest + Playwright coverage per acceptance criteria
  - CI updates and deployment scripts
- Tasks follow TDD ordering: migrations → validators → tests → Server Actions → UI → analytics/observability.
- Mark parallelizable items (`[P]`) for independent workstreams (e.g., component styling vs. analytics wiring).

## Progress Tracking
| Phase | Status | Notes |
|-------|--------|-------|
| Constitution Gate | ✅ | `.specify/memory/scaffold.ok` created via T000 scaffold run |
| Phase 0 – Research | ✅ | `research.md` finalized with six resolved decisions |
| Phase 1 – Design  | ✅ | `data-model.md`, `contracts/`, `quickstart.md` updated |
| Phase 2 – Tasks   | ⏳ | Ready for `/tasks` after scaffold gate satisfied |

## Ready for /tasks?
Proceed to `/tasks` once `T000 – Scaffold Next.js app` has been executed and `.specify/memory/scaffold.ok` exists. After scaffold completion, rerun `update-agent-context.sh codex`, then invoke `/tasks` using the latest prompts in `CODEX.md` with `.arguments/plan-tech-stack.md` as technical context.
